name: Build Windows Installer

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    env:
      VCPKG_OVERLAY_PORTS: ${{ github.workspace }}\pdf4qt\vcpkg\overlays\general
      VCPKG_INSTALLED_DIR: ${{ github.workspace }}\vcpkg_installed
      VCPKG_ROOT: ${{ github.workspace }}\vcpkg
      VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}\vcpkg-binary-cache
      QT_VERSION: '6.8.1'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: pdf4qt

      - name: Prepare vcpkg directories
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path $env:VCPKG_DEFAULT_BINARY_CACHE | Out-Null

      - name: Set up VCPKG
        shell: pwsh
        run: |
          git clone --depth=1 https://github.com/microsoft/vcpkg.git
          cd vcpkg
          .\bootstrap-vcpkg.bat -disableMetrics
          .\vcpkg integrate install

      - name: Cache vcpkg dependencies
        uses: actions/cache@v4
        with:
          path: |
            ./vcpkg/downloads
            ./vcpkg/packages
            ./vcpkg/installed
            ./vcpkg/archives
          key: ${{ runner.os }}-vcpkg-${{ hashFiles('**/vcpkg.json', '**/vcpkg-configuration.json') }}
          restore-keys: |
            ${{ runner.os }}-vcpkg-

      - name: Install vcpkg dependencies
        shell: pwsh
        run: |
          $manifestRoot = Join-Path $env:GITHUB_WORKSPACE 'pdf4qt'
          .\vcpkg install --triplet x64-windows --x-manifest-root=$manifestRoot --x-install-root=$env:VCPKG_INSTALLED_DIR --clean-buildtrees-after-build --clean-packages-after-build
        working-directory: vcpkg

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2022_64'
          dir: '${{ github.workspace }}/qt/'
          install-deps: 'true'
          modules: 'qtspeech qtmultimedia'
          cache: 'true'
          cache-key-prefix: ${{ runner.os }}-qt-${{ env.QT_VERSION }}

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Configure CMake
        working-directory: pdf4qt
        shell: pwsh
        run: |
          cmake -B build -S . `
            -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DPDF4QT_INSTALL_QT_DEPENDENCIES=ON `
            -DPDF4QT_INSTALL_DEPENDENCIES=ON `
            -DCMAKE_TOOLCHAIN_FILE="${env:GITHUB_WORKSPACE}\vcpkg\scripts\buildsystems\vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=x64-windows `
            -DPDF4QT_QT_ROOT="${env:Qt6_DIR}" `
            -DPDF4QT_INSTALL_MSVC_REDISTRIBUTABLE=ON `
            -DPDF4QT_INSTALL_PREPARE_WIX_INSTALLER=ON `
            -DPDF4QT_INSTALL_TO_USR=ON

      - name: Build project
        working-directory: pdf4qt
        shell: pwsh
        run: |
          cmake --build build --target release_translations --config Release --parallel
          cmake --build build --config Release --parallel
          cmake --install build --config Release

      - name: Install WiX Toolset
        shell: pwsh
        run: |
          choco install wixtoolset -y
          
      - name: Create MSI Installer
        working-directory: pdf4qt/build
        shell: pwsh
        run: |
          $env:PATH += ";C:\Program Files (x86)\WiX Toolset v3.11\bin"
          if (Test-Path "PDF4QT.wixproj") {
            msbuild PDF4QT.wixproj /p:Configuration=Release
          }

      - name: Upload MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PDF4QT-Windows-x64-MSI
          path: |
            pdf4qt/build/**/*.msi
            pdf4qt/build/install/usr/bin
          retention-days: 30

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            pdf4qt/build/**/*.msi
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
